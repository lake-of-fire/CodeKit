import $,{useEffect as B,useRef as G}from"react";async function A(r,h={}){typeof r=="object"&&!(r instanceof HTMLElement)&&r.view==="headless"&&(h=r,r=null);let{appUrl:v="https://livecodes.io/",params:m={},config:i={},import:b,lite:L,loading:g="lazy",template:C,view:D="split"}=h,P=D==="headless",s=null;if(typeof r=="string")s=document.querySelector(r);else if(r instanceof HTMLElement)s=r;else if(!(P&&typeof r=="object"))throw new Error("A valid container element is required.");if(!s)if(P)s=document.createElement("div"),k(s),document.body.appendChild(s);else throw new Error(`Cannot find element: "${r}"`);let a;try{a=new URL(v)}catch(e){throw new Error(`"${v}" is not a valid URL.`)}let E=a.origin;if(typeof m=="object"&&Object.keys(m).forEach(e=>{a.searchParams.set(e,String(m[e]))}),typeof i=="string")try{new URL(i),a.searchParams.set("config",i)}catch(e){throw new Error('"config" is not a valid URL or configuration object.')}else if(typeof i=="object")Object.keys(i).length>0&&a.searchParams.set("config","sdk");else throw new Error('"config" is not a valid URL or configuration object.');C&&a.searchParams.set("template",C),b&&a.searchParams.set("x",b),L&&a.searchParams.set("lite","true"),a.searchParams.set("embed","true"),a.searchParams.set("loading",P?"eager":g),a.searchParams.set("view",D);let S=!1,R="Cannot call API methods after calling `destroy()`.",y=await(()=>new Promise(e=>{var l,f,w,c,x,M,p,K,N;if(!s)return;let o=s.dataset.height||s.style.height;if(o&&!P){let O=isNaN(Number(o))?o:o+"px";s.style.height=O}s.dataset.defaultStyles!=="false"&&!P&&((l=s.style).backgroundColor||(l.backgroundColor="#fff"),(f=s.style).border||(f.border="1px solid black"),(w=s.style).borderRadius||(w.borderRadius="5px"),(c=s.style).boxSizing||(c.boxSizing="border-box"),(x=s.style).padding||(x.padding="0"),(M=s.style).width||(M.width="100%"),(p=s.style).height||(p.height=s.style.height||"300px"),s.style.minHeight="200px",(K=s.style).overflow||(K.overflow="hidden"),(N=s.style).resize||(N.resize="vertical"));let t=document.createElement("iframe");t.setAttribute("allow","accelerometer; camera; encrypted-media; display-capture; geolocation; gyroscope; microphone; midi; clipboard-read; clipboard-write; web-share"),t.setAttribute("allowtransparency","true"),t.setAttribute("allowpaymentrequest","true"),t.setAttribute("allowfullscreen","true"),t.setAttribute("sandbox","allow-same-origin allow-forms allow-modals allow-pointer-lock allow-popups allow-scripts");let n=g==="eager"?"eager":"lazy";t.setAttribute("loading",n),t.classList.add("livecodes"),P?k(t):(t.style.height="100%",t.style.minHeight="200px",t.style.width="100%",t.style.margin="0",t.style.border="0",t.style.borderRadius=s.style.borderRadius),addEventListener("message",function O(T){var W,z;T.source!==t.contentWindow||T.origin!==E||((W=T.data)==null?void 0:W.type)!=="livecodes-get-config"||(removeEventListener("message",O),(z=t.contentWindow)==null||z.postMessage({type:"livecodes-config",payload:i},E))}),t.onload=()=>{e(t)},t.src=a.href,s.appendChild(t)}))(),H=new Promise(e=>{addEventListener("message",function o(t){var n;t.source!==y.contentWindow||t.origin!==E||((n=t.data)==null?void 0:n.type)!=="livecodes-ready"||(removeEventListener("message",o),e(),H.settled=!0)})}),I=()=>S?Promise.reject(R):new Promise(async e=>{var t;H.settled&&e();let o={type:"livecodes-load"};(t=y.contentWindow)==null||t.postMessage(o,E),await H,e()}),d=(e,o)=>new Promise(async(t,n)=>{var f;if(S)return n(R);await I();let l=Q();addEventListener("message",function w(c){var x,M;if(!(c.source!==y.contentWindow||c.origin!==E||((x=c.data)==null?void 0:x.type)!=="livecodes-api-response"||((M=c.data)==null?void 0:M.id)!==l)&&c.data.method===e){removeEventListener("message",w);let p=c.data.payload;p!=null&&p.error?n(p.error):t(p)}}),(f=y.contentWindow)==null||f.postMessage({method:e,id:l,args:o},E)}),u={},F=["load","ready","code","console","tests","destroy"],U=(e,o)=>{var t;if(S)throw new Error(R);return F.includes(e)?(d("watch",[e]),u[e]||(u[e]=[]),(t=u[e])==null||t.push(o),{remove:()=>{var n,l;u[e]=(n=u[e])==null?void 0:n.filter(f=>f!==o),((l=u[e])==null?void 0:l.length)===0&&d("watch",[e,"unsubscribe"])}}):{remove:()=>{}}},J=e=>({"livecodes-app-loaded":"load","livecodes-ready":"ready","livecodes-change":"code","livecodes-console":"console","livecodes-test-results":"tests","livecodes-destroy":"destroy"})[e];addEventListener("message",async e=>{var n,l,f,w;let o=J((l=(n=e.data)==null?void 0:n.type)!=null?l:"");if(e.source!==y.contentWindow||e.origin!==E||!o||!u[o])return;let t=(f=e.data)==null?void 0:f.payload;(w=u[o])==null||w.forEach(c=>{c(t)})});let j=()=>{var e;Object.values(u).forEach(o=>{o.length=0}),(e=y==null?void 0:y.remove)==null||e.call(y),S=!0};g==="lazy"&&"IntersectionObserver"in window&&new IntersectionObserver((o,t)=>{o.forEach(async n=>{n.isIntersecting&&(await I(),t.unobserve(s))})},{rootMargin:"150px"}).observe(s);function k(e){e.style.position="absolute",e.style.top="0",e.style.visibility="hidden",e.style.opacity="0"}let Q=()=>(String(Math.random())+Date.now().toFixed()).replace("0.","");return{load:()=>I(),run:()=>d("run"),format:e=>d("format",[e]),getShareUrl:e=>d("getShareUrl",[e]),getConfig:e=>d("getConfig",[e]),setConfig:e=>d("setConfig",[e]),getCode:()=>d("getCode"),show:(e,o)=>d("show",[e,o]),runTests:()=>d("runTests"),onChange:e=>U("code",e),watch:U,exec:(e,...o)=>d("exec",[e,...o]),destroy:()=>H.settled?d("destroy").then(j):S?Promise.reject(R):(j(),Promise.resolve())}}var q;globalThis.document&&document.currentScript&&"prefill"in((q=document.currentScript)==null?void 0:q.dataset)&&window.addEventListener("load",()=>{document.querySelectorAll(".livecodes").forEach(r=>{let h,v=r.dataset.options;if(v)try{h=JSON.parse(v)}catch(b){}let m,i=r.dataset.config||r.dataset.prefill;if(i)try{m=JSON.parse(i)}catch(b){}A(r,{import:"dom/"+encodeURIComponent(r.outerHTML),...h,...m?{config:m}:{}})})});function V(r){let{className:h,style:v,height:m,sdkReady:i,...b}=r,L=G(null),g;return B(()=>{if(L.current)return A(L.current,b).then(C=>{g=C,typeof i=="function"&&i(C)}),()=>{g==null||g.destroy()}},[]),$.createElement("div",{ref:L,className:h,style:v,"data-height":m})}export{V as default};
